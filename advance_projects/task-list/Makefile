# ==========================================
# Task List æ‡‰ç”¨ç¨‹å¼ Makefile
# ==========================================
# æ”¯æ´å…©ç¨®éƒ¨ç½²æ–¹å¼:
#   1. é–‹ç™¼æ¸¬è©¦: docker-compose (make dev-*)
#   2. ç”Ÿç”¢éƒ¨ç½²: terraform (make prod-*)
# ==========================================

.PHONY: help dev-start dev-stop dev-restart dev-status dev-logs dev-clean \
        prod-init prod-plan prod-apply prod-destroy prod-status prod-output \
        build test maven-build maven-test maven-run setup

# é è¨­ç›®æ¨™
help: ## é¡¯ç¤ºèªªæ˜
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘        Task List æ‡‰ç”¨ç¨‹å¼éƒ¨ç½²ç®¡ç†å·¥å…·                      â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ“‹ éƒ¨ç½²æ–¹å¼ï¼š"
	@echo "  1ï¸âƒ£  é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ: docker-compose (make dev-*)"
	@echo "  2ï¸âƒ£  ç”Ÿç”¢éƒ¨ç½²ç’°å¢ƒ: terraform apply (make prod-*)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | \
		awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-18s\033[0m %s\n", $$1, $$2}'
	@echo ""

# ==========================================
# ğŸ—ï¸ é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ (Docker Compose)
# ==========================================

dev-start: ## å•Ÿå‹•é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ
	@echo "ğŸš€ å•Ÿå‹•é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ..."
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh start

dev-stop: ## åœæ­¢é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ
	@echo "ğŸ›‘ åœæ­¢é–‹ç™¼æ¸¬è©¦ç’°å¢ƒ..."
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh stop

dev-restart: ## é‡å•Ÿé–‹ç™¼æ¸¬è©¦ç’°å¢ƒ
	@echo "ğŸ”„ é‡å•Ÿé–‹ç™¼æ¸¬è©¦ç’°å¢ƒ..."
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh restart

dev-status: ## æŸ¥çœ‹é–‹ç™¼ç’°å¢ƒç‹€æ…‹
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh status

dev-logs: ## æŸ¥çœ‹é–‹ç™¼ç’°å¢ƒæ—¥èªŒ
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh logs

dev-logs-app: ## æŸ¥çœ‹æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh logs app

dev-logs-db: ## æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh logs postgres

dev-clean: ## æ¸…ç†é–‹ç™¼ç’°å¢ƒå’Œè³‡æ–™
	@chmod +x scripts/deploy-dev.sh
	@./scripts/deploy-dev.sh clean

# ==========================================
# ğŸš€ ç”Ÿç”¢éƒ¨ç½²ç’°å¢ƒ (Terraform)
# ==========================================

prod-init: ## åˆå§‹åŒ– Terraform
	@echo "ğŸ”§ åˆå§‹åŒ– Terraform..."
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh init

prod-plan: ## è¦åŠƒ Terraform éƒ¨ç½²
	@echo "ğŸ“‹ è¦åŠƒ Terraform éƒ¨ç½²..."
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh plan

prod-apply: ## æ‡‰ç”¨ Terraform éƒ¨ç½²
	@echo "ï¿½ æ‡‰ç”¨ Terraform éƒ¨ç½²..."
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh apply

prod-destroy: ## éŠ·æ¯€ç”Ÿç”¢ç’°å¢ƒ
	@echo "ï¿½ éŠ·æ¯€ç”Ÿç”¢ç’°å¢ƒ..."
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh destroy

prod-status: ## æŸ¥çœ‹ç”Ÿç”¢ç’°å¢ƒç‹€æ…‹
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh status

prod-output: ## æŸ¥çœ‹ Terraform è¼¸å‡º
	@chmod +x scripts/deploy-prod.sh
	@./scripts/deploy-prod.sh output

# ==========================================
# ğŸ”§ Maven å»ºç½®å‘½ä»¤
# ==========================================

maven-build: ## Maven å»ºç½®æ‡‰ç”¨ç¨‹å¼
	@echo "ğŸ”¨ Maven å»ºç½®..."
	@./mvnw clean package -DskipTests

maven-test: ## åŸ·è¡Œ Maven æ¸¬è©¦
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	@./mvnw test

maven-run: ## æœ¬åœ°é‹è¡Œ (éœ€è³‡æ–™åº«)
	@echo "ğŸƒ æœ¬åœ°é‹è¡Œ..."
	@./mvnw spring-boot:run

# ==========================================
# ğŸ› ï¸ é–‹ç™¼å·¥å…·å‘½ä»¤
# ==========================================

setup: ## åˆå§‹åŒ–é–‹ç™¼ç’°å¢ƒ
	@echo "ï¿½ï¸  åˆå§‹åŒ–é–‹ç™¼ç’°å¢ƒ..."
	@chmod +x mvnw
	@chmod +x scripts/*.sh
	@echo "âœ… é–‹ç™¼ç’°å¢ƒå·²æº–å‚™å°±ç·’"

build: ## å»ºç½® Docker æ˜ åƒ
	@echo "ï¿½ å»ºç½® Docker æ˜ åƒ..."
	@docker build -t task-list-app:latest .

test: ## åŸ·è¡Œå®Œæ•´æ¸¬è©¦
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	@./mvnw test

open-app: ## é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼
	@echo "ğŸŒ é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼..."
	@open http://localhost:8080 || xdg-open http://localhost:8080 || echo "http://localhost:8080"

open-pgadmin: ## é–‹å•Ÿ pgAdmin
	@echo "ğŸ”§ é–‹å•Ÿ pgAdmin..."
	@open http://localhost:5050 || xdg-open http://localhost:5050 || echo "http://localhost:5050"

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help