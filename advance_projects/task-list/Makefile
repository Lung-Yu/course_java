# Task List æ‡‰ç”¨ç¨‹å¼ Makefile

.PHONY: help build start stop clean status logs test terraform-init terraform-apply terraform-destroy quick-start

# é è¨­ç›®æ¨™
help: ## é¡¯ç¤ºèªªæ˜
	@echo "Task List æ‡‰ç”¨ç¨‹å¼ç®¡ç†å‘½ä»¤:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

quick-start: ## å¿«é€Ÿå•Ÿå‹•æ‡‰ç”¨ç¨‹å¼ (æ¨è–¦)
	@chmod +x quick-start.sh
	@./quick-start.sh

build: ## å»ºç½® Docker æ˜ åƒæª”
	@echo "ğŸ”¨ å»ºç½® Docker æ˜ åƒæª”..."
	@docker-compose build

start: ## å•Ÿå‹•æ‰€æœ‰æœå‹™
	@echo "ğŸš€ å•Ÿå‹•æ‰€æœ‰æœå‹™..."
	@docker-compose up -d

stop: ## åœæ­¢æ‰€æœ‰æœå‹™
	@echo "ğŸ›‘ åœæ­¢æ‰€æœ‰æœå‹™..."
	@docker-compose down

restart: ## é‡å•Ÿæ‰€æœ‰æœå‹™
	@echo "ğŸ”„ é‡å•Ÿæ‰€æœ‰æœå‹™..."
	@docker-compose restart

status: ## æª¢æŸ¥æœå‹™ç‹€æ…‹
	@echo "ğŸ“Š æª¢æŸ¥æœå‹™ç‹€æ…‹..."
	@docker-compose ps
	@echo ""
	@echo "ğŸ” å¥åº·æª¢æŸ¥:"
	@curl -s http://localhost:8080/actuator/health || echo "âŒ æ‡‰ç”¨ç¨‹å¼ç„¡æ³•é€£æ¥"
	@docker exec -it task-list-postgres pg_isready -U demo-task -d demo_task_db || echo "âŒ è³‡æ–™åº«ç„¡æ³•é€£æ¥"

logs: ## æŸ¥çœ‹æœå‹™æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹æœå‹™æ—¥èªŒ..."
	@docker-compose logs -f

logs-app: ## æŸ¥çœ‹æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ..."
	@docker-compose logs -f app

logs-db: ## æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ
	@echo "ğŸ“‹ æŸ¥çœ‹è³‡æ–™åº«æ—¥èªŒ..."
	@docker-compose logs -f postgres

clean: ## æ¸…ç†æ‰€æœ‰è³‡æº (åŒ…å« volumes)
	@echo "ğŸ§¹ æ¸…ç†æ‰€æœ‰è³‡æº..."
	@docker-compose down -v
	@docker system prune -f
	@docker volume prune -f

# Maven ç›¸é—œå‘½ä»¤
maven-build: ## ä½¿ç”¨ Maven å»ºç½®æ‡‰ç”¨ç¨‹å¼
	@echo "ğŸ”¨ ä½¿ç”¨ Maven å»ºç½®..."
	@./mvnw clean package -DskipTests

maven-test: ## åŸ·è¡Œ Maven æ¸¬è©¦
	@echo "ğŸ§ª åŸ·è¡Œæ¸¬è©¦..."
	@./mvnw test

maven-run: ## æœ¬åœ°é‹è¡Œæ‡‰ç”¨ç¨‹å¼ (éœ€è¦å…ˆå•Ÿå‹•è³‡æ–™åº«)
	@echo "ğŸƒ æœ¬åœ°é‹è¡Œæ‡‰ç”¨ç¨‹å¼..."
	@./mvnw spring-boot:run

# Terraform ç›¸é—œå‘½ä»¤
terraform-init: ## åˆå§‹åŒ– Terraform
	@echo "ğŸ”§ åˆå§‹åŒ– Terraform..."
	@cd infra && terraform init

terraform-plan: ## Terraform è¦åŠƒ
	@echo "ğŸ“‹ Terraform è¦åŠƒ..."
	@cd infra && terraform plan

terraform-apply: ## æ‡‰ç”¨ Terraform é…ç½®
	@echo "ğŸš€ æ‡‰ç”¨ Terraform é…ç½®..."
	@cd infra && terraform apply -auto-approve

terraform-destroy: ## éŠ·æ¯€ Terraform è³‡æº
	@echo "ğŸ’¥ éŠ·æ¯€ Terraform è³‡æº..."
	@cd infra && terraform destroy -auto-approve

# é–‹ç™¼ç›¸é—œå‘½ä»¤
dev-setup: ## é–‹ç™¼ç’°å¢ƒè¨­ç½®
	@echo "ğŸ› ï¸  è¨­ç½®é–‹ç™¼ç’°å¢ƒ..."
	@chmod +x mvnw
	@chmod +x scripts/*.sh
	@chmod +x quick-start.sh

db-only: ## åƒ…å•Ÿå‹•è³‡æ–™åº«
	@echo "ğŸ—„ï¸  å•Ÿå‹•è³‡æ–™åº«..."
	@docker-compose up -d postgres

open-app: ## åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹æ‡‰ç”¨ç¨‹å¼
	@echo "ğŸŒ åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹æ‡‰ç”¨ç¨‹å¼..."
	@open http://localhost:8080 || xdg-open http://localhost:8080 || echo "è«‹æ‰‹å‹•é–‹å•Ÿ http://localhost:8080"

open-pgadmin: ## åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ pgAdmin
	@echo "ğŸ”§ åœ¨ç€è¦½å™¨ä¸­æ‰“é–‹ pgAdmin..."
	@open http://localhost:5050 || xdg-open http://localhost:5050 || echo "è«‹æ‰‹å‹•é–‹å•Ÿ http://localhost:5050"

test: ## åŸ·è¡Œç³»çµ±åŠŸèƒ½æ¸¬è©¦
	@echo "ğŸ§ª åŸ·è¡Œç³»çµ±æ¸¬è©¦..."
	@chmod +x test-system.sh
	@./test-system.sh

# é è¨­ç›®æ¨™
.DEFAULT_GOAL := help